name: deploy-k8s
on:
  workflow_dispatch:
  workflow_run:
    workflows: [ "build" ]
    types: [ completed ]
permissions:
  contents: read
jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      REG_NS: ghcr.io/gammasportshop
      CHECK_URL: ${{ vars.WEB_CHECK_URL || secrets.WEB_CHECK_URL }}
      CHECK_CONTAINS: ${{ vars.WEB_CHECK_CONTAINS || secrets.WEB_CHECK_CONTAINS }}
    steps:
      - uses: actions/checkout@v4
        with:

          ref: ${{ github.event.workflow_run.head_sha }}
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${KUBE_CONFIG_DATA}" | base64 -d > $HOME/.kube/config
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      - name: Determine image SHA
        shell: bash
        run: |
          if [ -n "${{ github.event.workflow_run.head_sha }}" ]; then
            echo "SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          else
            echo "SHA=${{ github.sha }}" >> $GITHUB_ENV
          fi
      - name: Apply manifests
        run: kubectl apply -f main/k8s/
      - name: Update images
        run: |
          kubectl set image deployment/api api=$REG_NS/sportshop-api:$SHA
          kubectl set image deployment/web web=$REG_NS/sportshop-web:$SHA
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/api
          kubectl rollout status deployment/web
      - name: Collect deploy status and logs
        run: |
          kubectl get pods -A -o wide > k8s-pods.txt
          kubectl describe deployment/api > describe-deploy-api.txt
          kubectl describe deployment/web > describe-deploy-web.txt
          kubectl logs deployment/api --tail=300 > logs-api.txt || true
          kubectl logs deployment/web --tail=300 > logs-web.txt || true
      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: k8s-logs-${{ env.SHA || github.sha }}
          path: |
            k8s-pods.txt
            describe-deploy-api.txt
            describe-deploy-web.txt
            logs-api.txt
            logs-web.txt
      - name: HTTP health check
        if: ${{ env.CHECK_URL != '' }}
        shell: bash
        run: |
          echo "Checking $CHECK_URL"
          tries=20
          ok=0
          for i in $(seq 1 $tries); do
            code=$(curl -sk -o body.txt -w "%{http_code}" "$CHECK_URL" || true)
            echo "Attempt $i: HTTP $code"
            if [ "$code" = "200" ]; then
              if [ -n "$CHECK_CONTAINS" ]; then
                if grep -qi -- "$CHECK_CONTAINS" body.txt; then ok=1; break; fi
              else
                ok=1; break
              fi
            fi
            sleep 3
          done
          if [ $ok -ne 1 ]; then
            echo "HTTP check failed"
            exit 1
          fi
      - name: Upload HTTP body
        if: ${{ env.CHECK_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: http-body-${{ env.SHA || github.sha }}
          path: body.txt

